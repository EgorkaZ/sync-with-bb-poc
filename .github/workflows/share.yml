name: 'to bb'

on:
  push:
    branches:
      - master

jobs:
  filter_diff:
    name: Filter out exclusive part

    runs-on: ubuntu-20.04
    steps:
      - name: Checkout master
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Get diff
        id: shared_diff
        run: |
          echo "::set-output name=content::$( git diff --patch ${{ github.event.before }} -- . :^exclusive :^.github )"
      - name: Checkout BB upstream
        uses: actions/checkout@v2
        with:
          ref: bb-upstream
          persist-credentials: false
      - name: Commit shared changes
        if: steps.shared_diff.outputs.content != ''
        run: |
          git config --local user.email "zudin.0197@gmail.com"
          git config --local user.name "BB upstream action"
          echo ${{ steps.shared_diff.outputs.content }} | git apply
          git commit -m "Update BB upstream" -a
      - name: Push to BB upstream
        if: steps.shared_diff.outputs.content != ''
        uses: ad-m/github-push-action@master
        with:
          branch: bb-upstream
